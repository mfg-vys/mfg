<!DOCTYPE html>
<html>
<head>
  <title>Device Sign In/Out</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    .page { display: none; }
    .active { display: block; }
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    input, select { padding: 8px; font-size: 16px; width: 200px; margin: 5px 0; }
    #result { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <!-- Page 1: Choose Sign In or Sign Out -->
  <div id="page-choose" class="page active">
    <h1>Choose Action</h1>
    <button onclick="showPage('page-signin')">Sign In</button>
    <button onclick="showPage('page-signout')">Sign Out</button>
  </div>

  <!-- Page 2: Sign In form -->
  <div id="page-signin" class="page">
    <h1>Sign In</h1>
    <input id="signin-name" placeholder="Your Name" />
    <select id="signin-device">
      <option>Loading devices...</option>
    </select>
    <br/>
    <button onclick="submitSign('sign in')">Submit</button>
    <button onclick="showPage('page-choose')">Back</button>
    <div id="signin-result"></div>
  </div>

  <!-- Page 3: Sign Out form -->
  <div id="page-signout" class="page">
    <h1>Sign Out</h1>
    <input id="signout-name" placeholder="Your Name" />
    <select id="signout-device">
      <option>Loading devices...</option>
    </select>
    <br/>
    <button onclick="submitSign('sign out')">Submit</button>
    <button onclick="showPage('page-choose')">Back</button>
    <div id="signout-result"></div>
  </div>

  <script>
    // Your Supabase credentials
    const SUPABASE_URL = "https://tnzrbszknrorumoajgty.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuenJic3prbnJvcnVtb2FqZ3R5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NTM0MTAsImV4cCI6MjA2OTUyOTQxMH0.3Mw2Ke2csi0P2p9LXBv9v1cy1ORVMhgz-mCBqv7Uj4A";

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function showPage(id) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(id).classList.add('active');
      clearResults();
    }

    function clearResults() {
      ['signin-result', 'signout-result'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = "";
      });
    }

    async function loadDevices() {
      const { data, error } = await supabase.from('devices').select('id,type').order('type');
      console.log('Devices data:', data);
      console.log('Devices error:', error);
      if (error) {
        alert('Failed to load devices: ' + error.message);
        return;
      }
      ['signin-device', 'signout-device'].forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '';
        data.forEach(device => {
          const option = document.createElement('option');
          option.value = device.id;
          option.textContent = `${device.type} - ${device.id}`;
          select.appendChild(option);
        });
      });
    }

    async function submitSign(action) {
      const nameInput = document.getElementById(action === 'sign in' ? 'signin-name' : 'signout-name');
      const deviceSelect = document.getElementById(action === 'sign in' ? 'signin-device' : 'signout-device');
      const resultDiv = document.getElementById(action === 'sign in' ? 'signin-result' : 'signout-result');

      const user_name = nameInput.value.trim();
      const device_id = deviceSelect.value;

      if (!user_name || !device_id) {
        resultDiv.textContent = 'Please fill all fields.';
        return;
      }

      const { error } = await supabase.from('device_sign_logs').insert([{ 
        user_name,
        device_id,
        action
      }]);

      if (error) {
        resultDiv.textContent = 'Failed to submit: ' + error.message;
      } else {
        resultDiv.textContent = 'Success! Your entry was recorded.';
        nameInput.value = '';
        deviceSelect.selectedIndex = 0;
      }
    }

    window.onload = () => loadDevices();
  </script>
</body>
</html>
