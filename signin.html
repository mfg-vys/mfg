<!DOCTYPE html>
<html>
<head>
  <title>Device Sign In/Out</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    .page { display: none; }
    .active { display: block; }
  </style>
</head>
<body>
  <!-- Page 1: Choose Sign In or Sign Out -->
  <div id="page-choose" class="page active">
    <h1>Choose Action</h1>
    <button onclick="showPage('page-signin')">Sign In</button>
    <button onclick="showPage('page-signout')">Sign Out</button>
  </div>

  <!-- Page 2: Sign In form -->
  <div id="page-signin" class="page">
    <h1>Sign In</h1>
    <input id="signin-name" placeholder="Your Name" />
    <select id="signin-device">
      <!-- options dynamically loaded -->
    </select>
    <button onclick="submitSign('sign in')">Submit</button>
    <button onclick="showPage('page-choose')">Back</button>
    <div id="signin-result"></div>
  </div>

  <!-- Page 3: Sign Out form -->
  <div id="page-signout" class="page">
    <h1>Sign Out</h1>
    <input id="signout-name" placeholder="Your Name" />
    <select id="signout-device">
      <!-- options dynamically loaded -->
    </select>
    <button onclick="submitSign('sign out')">Submit</button>
    <button onclick="showPage('page-choose')">Back</button>
    <div id="signout-result"></div>
  </div>

  <script>
    // Supabase init
    const SUPABASE_URL = "https://your-project-ref.supabase.co";
    const SUPABASE_KEY = "your-anon-key";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Show only the specified page div
    function showPage(id) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(id).classList.add('active');
    }

    // Load device list dynamically to all select boxes
    async function loadDevices() {
      const { data, error } = await supabase.from('devices').select('id,name');
      if (error) {
        alert('Failed to load devices: ' + error.message);
        return;
      }
      ['signin-device', 'signout-device'].forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = ''; // clear previous
        data.forEach(device => {
          const option = document.createElement('option');
          option.value = device.id;
          option.textContent = device.name;
          select.appendChild(option);
        });
      });
    }

    // Called on submit from sign in/out forms
    async function submitSign(action) {
      const nameInput = document.getElementById(action === 'sign in' ? 'signin-name' : 'signout-name');
      const deviceSelect = document.getElementById(action === 'sign in' ? 'signin-device' : 'signout-device');
      const resultDiv = document.getElementById(action === 'sign in' ? 'signin-result' : 'signout-result');

      const user_name = nameInput.value.trim();
      const device_id = deviceSelect.value;

      if (!user_name || !device_id) {
        resultDiv.textContent = 'Please fill all fields.';
        return;
      }

      const { error } = await supabase.from('device_sign_logs').insert([{ 
        user_name,
        device_id,
        action
      }]);

      if (error) {
        resultDiv.textContent = 'Failed to submit: ' + error.message;
      } else {
        resultDiv.textContent = 'Success!';
      }
    }

    // Load devices on page load
    window.onload = () => loadDevices();
  </script>
</body>
</html>
