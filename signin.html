<!DOCTYPE html>
<html>
<head>
  <title>Device Sign In/Out</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    .page { display:none; padding:20px; }
    .page.active { display:block; }
    button { padding:10px; margin:5px; border:none; border-radius:5px; font-weight:bold; cursor:pointer; }
    .btn-primary { background:#007BFF; color:white; }
    .btn-secondary { background:#6c757d; color:white; }
    ul { list-style:none; padding:0; }
    li { padding:10px; border-bottom:1px solid #ccc; cursor:pointer; }
    li.selected { background:#007BFF; color:white; }
    .loading-spinner { margin:20px auto; width:36px; height:36px; border:4px solid #ccc; border-top-color:#007BFF; border-radius:50%; animation: spinner 0.6s linear infinite; }
    @keyframes spinner { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="page-choose" class="page active">
  <h1>What would you like to do?</h1>
  <button class="btn-primary" onclick="selectAction('take')">Take a Scanner</button>
  <button class="btn-primary" onclick="selectAction('return')">Return Scanner</button>
</div>

<div id="page-device" class="page">
  <h1 id="action-title"></h1>
  <button id="btn-mushiny" onclick="selectDeviceType('mushiny')" class="btn-secondary">Mushiny</button>
  <button id="btn-wms" onclick="selectDeviceType('wms')" class="btn-secondary">WMS</button>
  <ul id="device-list"></ul>
  <input type="text" id="user-name" placeholder="Enter your name" />
  <div>
    <button class="btn-primary" id="submit-btn" onclick="submitSign()" disabled>Submit</button>
    <button class="btn-secondary" onclick="backToAction()">Back</button>
  </div>
  <div id="result-message"></div>
</div>

<script>
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let selectedAction = null;
let selectedDeviceType = null;
let selectedDeviceId = null;

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('result-message').textContent = '';
}

function selectAction(action) {
  selectedAction = action;
  selectedDeviceType = null;
  selectedDeviceId = null;
  document.getElementById('btn-mushiny').classList.remove('active');
  document.getElementById('btn-wms').classList.remove('active');
  document.getElementById('action-title').textContent = action === 'take' ? 'Take a Scanner' : 'Return Scanner';
  document.getElementById('submit-btn').disabled = true;
  document.getElementById('user-name').value = '';
  document.getElementById('device-list').innerHTML = '';
  showPage('page-device');
}

async function selectDeviceType(type) {
  selectedDeviceType = type;
  selectedDeviceId = null;
  document.getElementById('submit-btn').disabled = true;

  const list = document.getElementById('device-list');
  list.innerHTML = '<div class="loading-spinner"></div>';

  let query = client.from('devices').select('id').eq('type', type);
  if (selectedAction === 'take') query = query.eq('current_status', 'available');
  if (selectedAction === 'return') query = query.eq('current_status', 'signed_out');

  const { data, error } = await query.order('id');

  if (error) {
    list.innerHTML = `<li>Error: ${error.message}</li>`;
    return;
  }
  if (!data || data.length === 0) {
    list.innerHTML = '<li>No devices found.</li>';
    return;
  }
  list.innerHTML = '';
  data.forEach(device => {
    const li = document.createElement('li');
    li.textContent = device.id;
    li.onclick = () => {
      selectedDeviceId = device.id.toString();
      highlightSelectedDevice(device.id.toString());
      document.getElementById('submit-btn').disabled = false;
    };
    list.appendChild(li);
  });
}

function highlightSelectedDevice(deviceId) {
  Array.from(document.getElementById('device-list').children)
    .forEach(li => li.classList.toggle('selected', li.textContent === deviceId));
}

async function submitSign() {
  const userName = document.getElementById('user-name').value.trim();
  const msg = document.getElementById('result-message');

  if (!selectedDeviceId) {
    msg.textContent = 'Please select a device.';
    return;
  }
  if (!userName) {
    msg.textContent = 'Please enter your name.';
    return;
  }

  // Call our Postgres function atomically
  const { error } = await client.rpc('sign_device', {
    _device_id: selectedDeviceId.toString(),
    _user_name: userName,
    _action: selectedAction
  });

  if (error) {
    msg.style.color = 'red';
    msg.textContent = `Error: ${error.message}`;
    return;
  }

  msg.style.color = 'green';
  msg.textContent = 'Success! Your entry was recorded.';
  setTimeout(() => showPage('page-choose'), 1500);
}

function backToAction() {
  showPage('page-choose');
}
</script>
</body>
</html>
